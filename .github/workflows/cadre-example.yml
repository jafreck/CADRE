# Example workflow for running CADRE in CI.
# Copy and adapt this file to your repository.
#
# cadre.config.json must exist at the repository root. Key fields to set:
#   - repoPath: set dynamically in the workflow steps below
#   - github.auth: choose PAT or GitHub App variant (see jobs below)
#
# Required GitHub App permissions (if using GitHub App auth):
#   - Issues: read
#   - Pull Requests: write
#   - Contents: write

name: CADRE

on:
  # Run on a schedule (e.g., every hour)
  schedule:
    - cron: "0 * * * *"

  # Allow manual triggering with an optional list of issue IDs
  workflow_dispatch:
    inputs:
      issue_ids:
        description: "Space-separated list of issue numbers to process (optional, e.g. '42 57')"
        required: false
        default: ""

  # Run when an issue is labeled
  issues:
    types: [labeled]

jobs:
  # ── PAT / GITHUB_TOKEN auth variant ──────────────────────────────────────────
  # Uses the built-in GITHUB_TOKEN (or a PAT stored as a repository secret).
  #
  # In cadre.config.json, set:
  #   "github": { "auth": { "token": "${GITHUB_TOKEN}" } }
  #
  # Delete this job if you are using GitHub App auth.
  cadre-pat:
    name: CADRE (PAT auth)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CADRE
        run: npm install -g cadre

      # Patch cadre.config.json to set repoPath to the current workspace
      - name: Set repoPath in CADRE config
        run: jq --arg rp "${{ github.workspace }}" '.repoPath = $rp' cadre.config.json > /tmp/cadre.config.json

      - name: Run CADRE
        # Pass --issue to restrict processing to specific issues when triggered manually
        run: |
          ISSUE_ARGS=""
          if [ -n "${{ github.event.inputs.issue_ids }}" ]; then
            ISSUE_ARGS=$(echo "${{ github.event.inputs.issue_ids }}" | xargs printf -- '--issue %s ')
          fi
          cadre run --config /tmp/cadre.config.json $ISSUE_ARGS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # To use a PAT instead of GITHUB_TOKEN, store it as a secret and reference it:
          # GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

  # ── GitHub App auth variant ───────────────────────────────────────────────────
  # Uses a GitHub App for finer-grained permission control.
  #
  # Secrets required:
  #   APP_ID          – GitHub App ID
  #   INSTALLATION_ID – Installation ID for this repository
  #   PRIVATE_KEY     – PEM-encoded private key for the GitHub App
  #
  # In cadre.config.json, set:
  #   "github": {
  #     "auth": {
  #       "appId": "${APP_ID}",
  #       "installationId": "${INSTALLATION_ID}",
  #       "privateKeyFile": "/tmp/cadre-private-key.pem"
  #     }
  #   }
  #
  # Delete this job if you are using PAT auth.
  cadre-app:
    name: CADRE (GitHub App auth)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install CADRE
        run: npm install -g cadre

      # Write the GitHub App private key from the repository secret to a temp file.
      # cadre.config.json should reference this path via "privateKeyFile": "/tmp/cadre-private-key.pem"
      - name: Write GitHub App private key
        run: echo "${{ secrets.PRIVATE_KEY }}" > /tmp/cadre-private-key.pem

      # Patch cadre.config.json to set repoPath to the current workspace
      - name: Set repoPath in CADRE config
        run: jq --arg rp "${{ github.workspace }}" '.repoPath = $rp' cadre.config.json > /tmp/cadre.config.json

      - name: Run CADRE
        # Pass --issue to restrict processing to specific issues when triggered manually
        run: |
          ISSUE_ARGS=""
          if [ -n "${{ github.event.inputs.issue_ids }}" ]; then
            ISSUE_ARGS=$(echo "${{ github.event.inputs.issue_ids }}" | xargs printf -- '--issue %s ')
          fi
          cadre run --config /tmp/cadre.config.json $ISSUE_ARGS
        env:
          APP_ID: ${{ secrets.APP_ID }}
          INSTALLATION_ID: ${{ secrets.INSTALLATION_ID }}
